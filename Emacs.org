#+TITLE: Daut's Configuration
#+PROPERTY: header-args:emacs-lisp :mkdirp yes :tangle .emacs.d/init.el
#+STARTUP: overview

* Runtime Performance
#+begin_src emacs-lisp
;; Improve lsp perf https://emacs-lsp.github.io/lsp-mode/page/performance/#increase-the-amount-of-data-which-emacs-reads-from-the-process
(setq read-process-output-max (* 4 1024 1024)) ;; Increase to 4mb for better performance with large responses

(defun daut/display-startup-time ()
  (message "Emacs loaded in %s with %d garbage collections."
           (format "%.2f seconds"
                   (float-time
                    (time-subtract after-init-time before-init-time)))
           gcs-done))
(add-hook 'emacs-startup-hook #'daut/display-startup-time)

;; Should make working with long lines faster https://emacs.stackexchange.com/questions/598/how-do-i-prevent-extremely-long-lines-making-emacs-slow
(setq bidi-inhibit-bpa t)
(setq bidi-paragraph-direction 'left-to-right)
(global-so-long-mode 1)

;; Garbage Collector Magic Hack
(use-package gcmh
  :diminish
  :hook (emacs-startup . gcmh-mode)
  :init
  (setq gcmh-idle-delay 'auto
        gcmh-auto-idle-delay-factor 10
        gcmh-high-cons-threshold #x2000000)) ; Increase to 32MB for better performance

#+end_src
* Package System Setup
#+begin_src emacs-lisp

;; Initialize package sources
(require 'package)
(setq package-archives '(("melpa" . "https://melpa.org/packages/")
                         ("org" . "https://orgmode.org/elpa/")
                         ("elpa" . "https://elpa.gnu.org/packages/")))
(package-initialize)
(unless package-archive-contents
  (package-refresh-contents))

;; Initialize use-package on non-Linux platforms
(unless (package-installed-p 'use-package)
  (package-install 'use-package))
(require 'use-package)
(setq use-package-always-ensure t)
(setq use-package-verbose t) ;; write useful information about package loading
(setq use-package-compute-statistics t) ;; report how much time a package needs to load

#+end_src

** Auto update packages
#+begin_src emacs-lisp

(use-package auto-package-update
  :custom
  ;; interval in days
  (auto-package-update-interval 7)
  (auto-package-update-prompt-before-update t)
  (auto-package-update-hide-results nil)
  :config
  (auto-package-update-maybe)
  (auto-package-update-at-time "09:00")
  (advice-add 'auto-package-update-now :after
              (lambda (&rest _)
                (when (fboundp 'package-vc-upgrade-all)
                  (package-vc-upgrade-all)))))

#+end_src
* Emacs Server
#+begin_src emacs-lisp
(use-package server
  :ensure nil
  :config
  (unless (server-running-p)
    (server-start)))
#+end_src
* Keep init.el Clean
#+begin_src emacs-lisp

;; Save all of the custom data in custom.el
(setq custom-file (concat user-emacs-directory "custom.el"))
(when (file-exists-p custom-file)
  (load custom-file))
(use-package no-littering
  :config
  (setq create-lockfiles nil))

 #+end_src
* Environment Vars
Environment variables sometimes aren't right, this fixes it.
#+begin_src emacs-lisp
(use-package exec-path-from-shell
  :if (memq window-system '(mac ns x))
  :demand
  :config
  (setq exec-path-from-shell-check-startup-files nil)
  (setq exec-path-from-shell-variables '("PATH" "MANPATH" "GOPATH" "GOPRIVATE" "PYTHONPATH" "NODE_PATH" "RUSTUP_HOME" "CARGO_HOME"))
  (setq exec-path-from-shell-arguments '("-l"))
  (exec-path-from-shell-initialize))
#+end_src
* Info Docs
#+begin_src emacs-lisp
(add-to-list 'Info-directory-list
             (expand-file-name "./books" user-emacs-directory))
#+end_src
* Font Configuration

#+begin_src emacs-lisp
(use-package emacs
  :custom
  (enable-recursive-minibuffers t)
  (pixel-scroll-precision-mode t)
  :config
  (defvar daut/default-font-size 150)
  (set-face-attribute 'default nil :font "JetBrains Mono" :height daut/default-font-size)
  (setopt line-spacing 0.2)
  ;; necessary as a fallback for org-modern mode
  (set-fontset-font "fontset-default" '(#x2BC6 . #x2BC6)
                    (font-spec :family "Iosevka Aile") nil 'append))

(use-package ligature
  :config
  (ligature-set-ligatures 'prog-mode '("--" "---" "==" "===" "!=" "!==" "=!="
                              "=:=" "=/=" "<=" ">=" "&&" "&&&" "&=" "++" "+++" "***" ";;" "!!"
                              "??" "???" "?:" "?." "?=" "<:" ":<" ":>" ">:" "<:<" "<>" "<<<" ">>>"
                              "<<" ">>" "||" "-|" "_|_" "|-" "||-" "|=" "||=" "##" "###" "####"
                              "#{" "#[" "]#" "#(" "#?" "#_" "#_(" "#:" "#!" "#=" "^=" "<$>" "<$"
                              "$>" "<+>" "<+" "+>" "<*>" "<*" "*>" "</" "</>" "/>" "<!--" "<#--"
                              "-->" "->" "->>" "<<-" "<-" "<=<" "=<<" "<<=" "<==" "<=>" "<==>"
                              "==>" "=>" "=>>" ">=>" ">>=" ">>-" ">-" "-<" "-<<" ">->" "<-<" "<-|"
                              "<=|" "|=>" "|->" "<->" "<~~" "<~" "<~>" "~~" "~~>" "~>" "~-" "-~"
                              "~@" "[||]" "|]" "[|" "|}" "{|" "[<" ">]" "|>" "<|" "||>" "<||"
                              "|||>" "<|||" "<|>" "..." ".." ".=" "..<" ".?" "::" ":::" ":=" "::="
                              ":?" ":?>" "//" "///" "/*" "*/" "/=" "//=" "/==" "@_" "__" "???"
                              "<:<" ";;;"))
  (global-ligature-mode t))
#+end_src
* Completion Configuration
** Which Key

~which-key~ is a useful UI panel that appears when you start pressing any key binding in Emacs to offer you all possible completions for the key sequence you are typing. It is a great way to learn Emacs key bindings and to discover new ones.

#+begin_src emacs-lisp

(use-package which-key
  :defer 0
  :diminish which-key-mode
  :config
  (which-key-mode)
  (setq which-key-idle-delay 0.3))

#+end_src
** Vertico + Consult + Marginalia + Embark + Orderless
#+begin_src emacs-lisp
(defun daut/minibuffer-backward-kill (arg)
  (interactive "p")
  (if (and minibuffer-completing-file-name
           (eq (char-before) ?/))
      (zap-up-to-char (- arg) ?/)
    (delete-backward-char arg)))

(use-package vertico
  :init (vertico-mode)
  :bind (:map vertico-map
         ("<backspace>" . daut/minibuffer-backward-kill)))

(use-package vertico-posframe
  :init (vertico-posframe-mode)
  :config
  (setq vertico-multiform-commands
        '((consult-line (:not posframe))
          (consult-ripgrep (:not posframe))
          (t posframe)))
  (vertico-multiform-mode t))

(defun daut/selected-region-or-symbol-at-point ()
  "Return the selected region, otherwise return the symbol at point."
  (if (region-active-p)
      (buffer-substring-no-properties (region-beginning) (region-end))
    (thing-at-point 'symbol t)))
;; TODO: https://www.reddit.com/r/emacs/comments/16g08me/killbuffer_from_the_minibuffer_after_mx/
(use-package consult
  :bind
  ("C-s"   . consult-line)
  ("C-x b" . consult-buffer)
  ("s-F"   . consult-ripgrep)
  ;; goto
  ("M-g i" . consult-imenu)
  ;; search
  ("M-s d" . consult-find)
  :config
  (consult-customize
   consult-ripgrep consult-git-grep consult-grep
   :initial (daut/selected-region-or-symbol-at-point)))

(use-package consult-flycheck
  :bind
  ("M-g f" . consult-flycheck))

(use-package marginalia
  :init (marginalia-mode))

(use-package embark
  :bind (("C-."   . embark-act)
         ("C-;"   . embark-dwim)
         ("C-h B" . embark-bindings)))

;; If you use the grepping commands from the Consult package, consult-grep, consult-git-grep or consult-ripgrep, then you should install the embark-consult package, which adds support for exporting a list of grep results to an honest grep-mode buffer, on which you can even use wgrep if you wish.
(use-package embark-consult)

(use-package wgrep)

;; Persist history over Emacs restarts. Vertico sorts by history position.
(use-package savehist
  :init
  (savehist-mode))

;; improved completion style
(use-package orderless
  :custom
  (completion-styles '(orderless basic))
  (completion-category-defaults nil)
  (completion-category-overrides nil)
  :config
  (setq orderless-matching-styles '(orderless-literal orderless-regexp)))
#+end_src

#+RESULTS:

* UI Configuration
** Basic
#+begin_src emacs-lisp
;; Show line numbers
(use-package display-line-numbers
  :ensure nil
  :hook ((prog-mode nxml-mode yaml-ts-mode conf-mode astro-ts-mode) . display-line-numbers-mode)
  :init (setq display-line-numbers-width-start t))

;; Display ugly ^L page breaks as tidy horizontal lines
(use-package page-break-lines
  :diminish
  :hook (after-init . global-page-break-lines-mode))

(use-package pulsar
  :init
  (pulsar-global-mode)
  :hook
  (consult-after-jump . pulsar-recenter-center))

#+end_src
** Dashboard
#+begin_src emacs-lisp
(use-package dashboard
  :ensure t
  :custom
  (dashboard-startup-banner (concat user-emacs-directory "themes/emacs.txt"))
  (dashboard-icon-type 'nerd-icons)
  (dashboard-display-icons-p t)
  :config
  (dashboard-setup-startup-hook)
  (add-to-list 'dashboard-footer-messages "Person who say it cannot be done should not interrupt person doing it.")
  (setq dashboard-center-content t
        dashboard-items '((projects . 4)
                          (recents . 4)
                          (bookmarks . 4)
                          (agenda . 4))
        dashboard-set-file-icons t
        dashboard-set-heading-icons t))
#+end_src
** Solaire Mode
#+begin_src emacs-lisp
;; Make certain buffers different in color
;; e.g. popups, sidebars, terminals, etc.
(use-package solaire-mode
  :hook (after-init . solaire-global-mode))
#+end_src
** Color Themes
#+begin_src emacs-lisp
(defun daut/print-current-theme ()
  "Print the currently active theme."
  (interactive)
  (if custom-enabled-themes
      (message "Current theme: %s" (car custom-enabled-themes))
    (message "No theme is currently active")))

(defun daut/random-color-theme ()
  "Load a random theme from the available themes."
  (interactive)
  (let ((themes (custom-available-themes)))
    (random t)
    (let ((selected-theme (nth (random (length themes)) themes)))
      (load-theme selected-theme t)
      (message "Selected theme: %s" selected-theme))))
#+end_src
** Better Mode Line
#+begin_src emacs-lisp
(use-package doom-modeline
  :init (doom-modeline-mode 1)
  :custom ((doom-modeline-height 15)))

(use-package nerd-icons)

;; Hide modelline in some major modes
(use-package hide-mode-line
  :hook (((eshell-mode shell-mode
           term-mode vterm-mode
           ;; embark-collect-mode
           lsp-ui-imenu-mode
           pdf-annot-list-mode) . hide-mode-line-mode)))
#+end_src
** Helpful Help Commands
Helpful is an alternative to emacs builtin help which provides much more contextual information andbetter user experience
#+begin_src emacs-lisp

(use-package helpful
:bind
   ([remap describe-key]      . helpful-key)
   ([remap describe-command]  . helpful-command)
   ([remap describe-variable] . helpful-variable)
   ([remap describe-function] . helpful-callable))

#+end_src

** Indent Guides
#+begin_src emacs-lisp
(use-package highlight-indent-guides
  :hook ((prog-mode astro-ts-mode) . highlight-indent-guides-mode)
  :init (setq highlight-indent-guides-method 'character
              highlight-indent-guides-responsive 'top
              highlight-indent-guides-suppress-auto-error t))
#+end_src

** Colorful
#+begin_src emacs-lisp
(use-package colorful-mode
  :config
  (global-colorful-mode)
  (add-to-list 'global-colorful-modes 'helpful-mode))
#+end_src
* Editing Configuration
** Basic
#+begin_src emacs-lisp
;; When you visit a file, point goes to the last place
;; where it was when you previously visited the same file.
(use-package save-place
  :ensure nil
  :hook (after-init . save-place-mode))

;; Recentf is a minor mode that builds a list of recently opened files.
;; This list is automatically saved across sessions on exiting
;; Emacs - you can then access this list through a command or the menu.
(use-package recentf
  :bind (("C-x C-r" . recentf-open-files))
  :hook (after-init . recentf-mode)
  :init (setq recentf-max-saved-items 300
	            recentf-exclude
	            '("\\.?cache" ".cask" "url" "COMMIT_EDITMSG\\'" "bookmarks"
                "\\.\\(?:gz\\|gif\\|svg\\|png\\|jpe?g\\|bmp\\|xpm\\)$"
                "\\.?ido\\.last$" "\\.revive$" "/G?TAGS$" "/.elfeed/"
                "^/tmp/" "^/var/folders/.+$" "^/ssh:" "/persp-confs/"
                (lambda (file) (file-in-directory-p file package-user-dir))))
  :config
  (push (expand-file-name recentf-save-file) recentf-exclude)
  (add-to-list 'recentf-filename-handlers #'abbreviate-file-name))

;; Simple
(use-package simple
  :ensure nil
  :hook ((after-init . size-indication-mode)
	       (text-mode . visual-line-mode)
	       ((prog-mode markdown-mode conf-mode restclient-mode) . enable-delete-trailing-whitespace))
  :init
  (setq column-number-mode t
	      line-number-mode t)
  ;; Visualize TAB, (HARD) SPACE, NEWLINE
  (setq-default show-trailing-whitespace nil) ; Don't show trailing whitespace by default
  (defun enable-delete-trailing-whitespace ()
    "Show trailing spaces and delete on saving."
    (setq show-trailing-whitespace t)
    (add-hook 'before-save-hook #'delete-trailing-whitespace nil t)))

;; Enable short answers
(if (boundp 'use-short-answers)
    (setq use-short-answers t)
  (fset 'yes-or-no-p 'y-or-n-p))
#+end_src
** Flyspell
#+begin_src emacs-lisp
(use-package flyspell
  :ensure nil
  :diminish
  :if (executable-find "aspell")
  :hook ((org-mode markdown-mode text-mode outline-mode) . flyspell-mode))
#+end_src
** Subword
#+begin_src emacs-lisp
;; Handling capitalized subwords in a nomenclature
(use-package subword
  :ensure nil
  :diminish
  :hook ((prog-mode . subword-mode)
         (minibuffer-setup . subword-mode)))
#+end_src
** Delete selection with a keypress
#+begin_src emacs-lisp

(delete-selection-mode t)

#+end_src
** Tab Width
#+begin_src emacs-lisp
(setq-default tab-width 2)
#+end_src

** Use spaces instead of tabs for indentation
#+begin_src emacs-lisp

(setq-default indent-tabs-mode nil)

#+end_src
** Commenting lines
#+begin_src emacs-lisp

(use-package evil-nerd-commenter
  :bind ("s-/" . evilnc-comment-or-uncomment-lines))

#+end_src
** Insert newline at the end of the file
#+begin_src emacs-lisp

(setq require-final-newline t)

#+end_src
** Parenthesis matching

#+begin_src emacs-lisp

(use-package paren
  :config
  (show-paren-mode +1))

(use-package elec-pair
  :config
  (electric-pair-mode +1)
  :init (setq electric-pair-inhibit-predicate 'electric-pair-default-inhibit))
#+end_src
** Multiple cursors
#+begin_src emacs-lisp

(use-package multiple-cursors
  :bind ("s-d" . mc/mark-next-like-this-symbol))

#+end_src
** Move line/region up/down
#+begin_src emacs-lisp

(use-package move-text
  :bind
  ("C-s-j" . 'move-text-down)
  ("C-s-k" . 'move-text-up))

#+end_src
** Text folding
#+begin_src emacs-lisp
(use-package hideshow
  :diminish hs-minor-mode
  :hook
  (prog-mode . hs-minor-mode)
  (restclient-mode . hs-minor-mode)
  (nxml-mode . hs-minor-mode)
  (web-mode . hs-minor-mode)
  (html-mode . hs-minor-mode)
  :bind
  ("C-s-[" . hs-hide-block)
  ("C-s-]" . hs-show-block))
#+end_src
** Indentation
#+begin_src emacs-lisp

(use-package aggressive-indent
  :diminish
  :hook (emacs-lisp-mode . aggressive-indent-mode))

#+end_src
** Expand Region
#+begin_src emacs-lisp
(use-package expand-region
  :bind ("C-=" . er/expand-region))
#+end_src
** Open Recently Closed File
#+begin_src emacs-lisp
(defvar daut/killed-file-list nil
  "List of recently killed files")

(defun daut/add-file-to-killed-file-list ()
  (when buffer-file-name
    (push buffer-file-name daut/killed-file-list)))

(add-hook 'kill-buffer-hook #'daut/add-file-to-killed-file-list)

(defun daut/reopen-killed-file ()
  (interactive)
  (when daut/killed-file-list
    (find-file (pop daut/killed-file-list))))

(global-set-key (kbd "s-T") 'daut/reopen-killed-file)
#+end_src
** Respect .editorconfig
Doesn't play nicely with web-mode. Sets `web-mode-script-padding` to 2, even though there is no .editorconfig present in the project. 
#+begin_src emacs-lisp
;; (use-package editorconfig
;;   :hook (after-init . editorconfig-mode))
#+end_src
** Olivetti for nicer text editing
#+begin_src emacs-lisp
(use-package olivetti
  :hook (org-mode . olivetti-mode))
#+end_src
** Guess Indent
#+begin_src emacs-lisp
(use-package dtrt-indent)
#+end_src
* Org Mode Configuration
** Basic Configuration
#+begin_src emacs-lisp

(defun daut/org-mode-setup ()
  (org-indent-mode)
  (visual-line-mode 1))

(use-package org
  :hook ((org-mode . daut/org-mode-setup))
  :commands (org-capture org-agenda)
  :bind (:map org-mode-map
              ("M-RET" . org-insert-item))
  :config
  ;; https://github.com/minad/consult/issues/1153
  (setq org-fold-core-style 'overlays)
  (setq org-ellipsis " â–¾")
  (setq org-agenda-start-with-log-mode t)
  (setq org-log-done 'time)
  (setq org-agenda-files
        '("~/projects/org/gtd/inbox.org"
          "~/projects/org/gtd/gtd.org"
          "~/projects/org/gtd/tickler.org"))
  (setq org-refile-targets '(("~/projects/org/gtd/gtd.org" :maxlevel . 2)
                             ("~/projects/org/gtd/someday.org" :level . 1)
                             ("~/projects/org/gtd/tickler.org" :maxlevel . 1)))
  (setq org-capture-templates '(("t" "TODO [inbox]" entry
                                 (file+headline "~/projects/org/gtd/inbox.org" "Tasks")
                                 "* TODO %i%?")
                                ("T" "Tickler" entry
                                 (file+headline "~/projects/org/gtd/tickler.org" "Tickler")
                                 "* %i% \n %U"))))

(use-package org-modern
  :hook (org-mode . org-modern-mode))

;; same effect for `tab' as in the language major mode buffer
(setq
 org-src-preserve-indentation t
 org-src-tab-acts-natively t)

#+end_src
** Org Babel Languages Configuration
#+begin_src emacs-lisp

(with-eval-after-load 'org
  (org-babel-do-load-languages
   'org-babel-load-languages
   '((emacs-lisp . t)
     (python . t)
     (sql . t)
     (js . t)))

  (setq org-confirm-babel-evaluate nil))

#+end_src
** Structure Templates
#+begin_src emacs-lisp

(with-eval-after-load 'org
  ;; This is needed as of Org 9.2
  (require 'org-tempo)

  (add-to-list 'org-structure-template-alist '("js" . "src javascript"))
  (add-to-list 'org-structure-template-alist '("sh" . "src shell"))
  (add-to-list 'org-structure-template-alist '("el" . "src emacs-lisp"))
  (add-to-list 'org-structure-template-alist '("py" . "src python"))
  (add-to-list 'org-structure-template-alist '("sq" . "src sql")))

#+end_src
** Auto-tangle Configuration Files
#+begin_src emacs-lisp

;; Automatically tangle Emacs.org config file on save
(defun daut/org-babel-tangle-configuration ()
  (when (string-equal (buffer-file-name)
		          (expand-file-name "~/projects/dotfiles/Emacs.org"))
    (let ((org-confirm-babel-evaluate nil))
      (org-babel-tangle))))

(add-hook 'org-mode-hook (lambda () (add-hook 'after-save-hook #'daut/org-babel-tangle-configuration)))

#+end_src
** Org Roam
#+begin_src emacs-lisp
(use-package org-roam
  :custom
  (org-roam-directory "~/roam-notes")
  (org-roam-completion-everywhere t)
  :bind (("C-c n l" . org-roam-buffer-toggle)
         ("C-c n f" . org-roam-node-find)
         ("C-c n i" . org-roam-node-insert)
         :map org-mode-map
         ("C-M-i" . completion-at-point))
  :config
  (org-roam-setup))
#+end_src
** Pomodoro
#+begin_src emacs-lisp
(setq org-clock-sound t)
#+end_src
* Development
** Compilation
#+begin_src emacs-lisp
(use-package compile
  :ensure nil
  :hook (compilation-filter . ansi-color-compilation-filter)
  :bind(("C-c C-r" . recompile)
        ("C-c c" . switch-to-compilation-buffer))
  :config
  (defun switch-to-compilation-buffer ()
    (interactive)
    (switch-to-buffer "*compilation*"))
  (setq compilation-scroll-output t)
  (setopt compilation-ask-about-save nil))
#+end_src
** Projectile

#+begin_src emacs-lisp

(defun daut/open-project-in-ghostty-opencode ()
  "Open current Projectile project in a new Ghostty tab and start opencode."
  (interactive)
  (let ((project-root (projectile-project-root)))
    (if project-root
        (let* ((command (format "cd %s && opencode" (shell-quote-argument project-root)))
               (applescript
                (format "
tell application \"Ghostty\" to activate
tell application \"System Events\"
    tell process \"Ghostty\"
        keystroke \"t\" using command down
        delay 0.5
        keystroke \"%s\"
        keystroke return
    end tell
end tell" command)))
          (do-applescript applescript))
      (message "Not in a Projectile project"))))

(use-package projectile
  :diminish projectile-mode
  :hook (after-init . projectile-mode)
  :bind
  ("C-c p" . projectile-command-map)
  ("s-p" . projectile-find-file)
  (:map projectile-command-map
        ("G" . daut/open-project-in-ghostty-opencode))
  :init
  (setq projectile-sort-order 'recentf)
  (setq projectile-auto-discover nil)
  (when (file-directory-p "~/projects")
    (setq projectile-project-search-path '(("~/projects" . 3))))
  (setq projectile-switch-project-action #'projectile-dired)
  (setq projectile-git-submodule-command nil)
  (setq projectile-use-git-grep t))
#+end_src
** Rainbow Delimiters

#+begin_src emacs-lisp

;; install rainbow delimiters and hook them to any prog-mode (programming language mode)
(use-package rainbow-delimiters
  :hook (prog-mode . rainbow-delimiters-mode))

#+end_src

** Company Mode
#+begin_src emacs-lisp
(use-package company
  :hook (after-init . global-company-mode)
  :bind
  (:map company-active-map
        ("<tab>" . nil)
        ("TAB" . nil))
  :config
  ;; Number the candidates (use M-1, M-2 etc to select completions).
  (setopt company-show-quick-access t)
  (setopt company-minimum-prefix-length 1)
  (setopt company-idle-delay 0)
  (setopt company-transformers '(delete-consecutive-dups
                             company-sort-by-occurrence
                             company-sort-prefer-same-case-prefix))
  :init
  (setopt company-backends '((company-capf :with company-yasnippet company-dabbrev-code)
                           (company-dabbrev-code company-keywords company-files)
                           company-dabbrev)))

(use-package company-box
  :hook (company-mode . company-box-mode))

(use-package company-statistics
  :hook (after-init . company-statistics-mode))

#+end_src
** Yasnippet
#+begin_src emacs-lisp

;; yasnippet
(use-package yasnippet
  :diminish yas-minor-mode
  :hook (after-init . yas-global-mode)
  :config
  (setq yas-snippet-dirs '("~/.emacs.d/snippets")))

#+end_src
** Languages
*** Language Servers
#+begin_src emacs-lisp

(use-package lsp-mode
  :commands (lsp lsp-deferred)
  :config
  (lsp-enable-which-key-integration t)
  ;; js/ts related options
  (setopt lsp-javascript-preferences-import-module-specifier "relative")
  (setopt lsp-typescript-preferences-import-module-specifier "relative")
  (setopt lsp-completion-provider :none)
  (setopt lsp-headerline-breadcrumb-enable nil)
  (setopt lsp-javascript-suggest-complete-function-calls t)
  (add-to-list 'lsp-disabled-clients '(typescript-mode . vue-semantic-server))
  (add-to-list 'lsp-disabled-clients '(typescript-ts-mode . vue-semantic-server))
  (add-to-list 'lsp-disabled-clients '(js-mode . vue-semantic-server))
  (add-to-list 'lsp-disabled-clients '(js-ts-mode . vue-semantic-server))
  (add-to-list 'lsp-disabled-clients '(astro-ts-mode . vue-semantic-server))
  (add-to-list 'lsp-disabled-clients '(css-mode . vue-semantic-server))
  ;; https://github.com/emacs-lsp/lsp-mode/issues/2915#issuecomment-855156802
  (add-to-list 'lsp-language-id-configuration '(".*\\.liquid" . "html"))
  (setf (alist-get 'web-mode lsp--formatting-indent-alist) 'web-mode-code-indent-offset))
  ;; turn off lsp diagnostics to let flycheck do the job
  ;; (setq lsp-diagnostics-provider :none))

;; enhanced ui e.g. documentation popup
(use-package lsp-ui
  :hook (lsp-mode . lsp-ui-mode)
  :config
  (setq lsp-ui-doc-position 'top)
  (setq lsp-ui-doc-delay 0.5)
  (setq lsp-ui-doc-max-width 80)
  (general-define-key
   :keymaps 'lsp-mode-map
   :prefix lsp-keymap-prefix
   "u" '(:ignore t :wk "lsp ui")
   "ui" '(lsp-ui-imenu t :which-key "imenu")))

;; lsp-treemacs provides tree-like views for various LSP features
(use-package lsp-treemacs
  :after lsp-mode)

#+end_src
*** Debugging With dape
#+begin_src emacs-lisp
(use-package dape
  :defer t
  :config
  (setq dape-buffer-window-arrangement 'right)
  (setq dape-inlay-hints t)
  (setq dape-cwd-fn 'projectile-project-root)
  (add-to-list 'dape-configs
               `(go-debug-main
                 modes (go-mode go-ts-mode)
                 command "dlv"
                 command-args ("dap" "--listen" "127.0.0.1::autoport" "--log-dest" "/tmp/dlv.log")
                 command-cwd dape-command-cwd
                 port :autoport
                 :type "debug"
                 :request "launch"
                 :name "Debug Go Program"
                 :program "."
                 :mode "debug"
                 :args [])))
#+end_src
*** Bash
#+begin_src emacs-lisp
(use-package bash-ts-mode
  :ensure nil
  :mode "\\.sh\\'"
  :mode "\\.bash\\'"
  :hook (bash-ts-mode . lsp-deferred)
  :config
  (setq sh-basic-offset 2))
(add-to-list 'interpreter-mode-alist '("bash" . bash-ts-mode))
#+end_src
*** TypeScript
#+begin_src emacs-lisp

(use-package typescript-ts-mode
  :ensure nil
  :mode "\\.ts\\'"
  :mode "\\.tsx\\'"
  :hook (typescript-ts-mode . lsp-deferred)
  :config
  (setq typescript-indent-level 2))

#+end_src
*** JavaScript
#+begin_src emacs-lisp
(use-package js-ts-mode
  :ensure nil
  :mode (("\\.js\\'" . js-ts-mode)
         ("\\.jsx\\'" . js-ts-mode)
         ("\\.cjs\\'" . js-ts-mode)
         ("\\.mjs\\'" . js-ts-mode))
  :hook
  (js-ts-mode . lsp-deferred)
  (js-ts-mode . dtrt-indent-mode)
  :config
  (setq js-indent-level 2))

;; Adds node_modules/.bin directory to `exec_path'
;; This allows Emacs to find project based installs of e.g. eslint.
(use-package add-node-modules-path
  :hook ((web-mode js-ts-mode js-mode js2-mode) . add-node-modules-path))
#+end_src
*** Java
#+begin_src emacs-lisp
(use-package java-ts-mode
  :ensure nil
  :mode "\\.java\\'"
  :hook (java-ts-mode . treesit-fold-mode))

(use-package lsp-java
  :hook (java-ts-mode . (lambda ()
                          (require 'lsp-java)
                          (lsp-deferred)))
  :config
  (add-to-list 'lsp-java-vmargs
               "-javaagent:/Users/boza/.m2/repository/org/projectlombok/lombok/1.18.38/lombok-1.18.38.jar"))
#+end_src
*** Lua
#+begin_src emacs-lisp

(use-package lua-mode
  :mode "\\.lua\\'"
  :hook (lua-mode . lsp-deferred)
  :config
  (setq lua-indent-level 2))

#+end_src
*** Go
#+begin_src emacs-lisp
(use-package go-ts-mode
  :mode "\\.go\\'"
  :hook
  (go-ts-mode . lsp-deferred)
  (go-ts-mode . treesit-fold-mode)
  (before-save . gofmt-before-save)
  (go-ts-mode . (lambda () (setq tab-width 2)))
  (go-ts-mode . (lambda () (setq go-ts-mode-indent-offset 2))))

(use-package go-playground
  :after go-ts-mode)

(use-package gotest
  :after go-ts-mode)

(use-package flycheck-golangci-lint
  :hook (go-ts-mode . flycheck-golangci-lint-setup))

#+end_src
*** JSON
#+begin_src emacs-lisp

(use-package json-ts-mode
  :ensure nil
  :mode "\\.json\\'"
  :mode "\\.prettierrc\\'"
  :hook
  (json-ts-mode . lsp-deferred)
  :config
  (setq js-indent-level 2))

#+end_src
*** Restclient
#+begin_src emacs-lisp
(use-package jq-mode)

(use-package restclient
  :mode ("\\.http\\'" . restclient-mode)
  :config
  (setq restclient-enable-eval t)
  (with-eval-after-load 'company
    (use-package company-restclient
      :defines company-backends
      :init (add-to-list 'company-backends 'company-restclient))))

(use-package restclient-jq
  :after restclient)

#+end_src
*** Hurl
#+begin_src emacs-lisp
(use-package hurl-mode
  :vc (:url "https://github.com/JasZhe/hurl-mode"
       :rev :newest
       :branch "main")
  :mode "\\.hurl\\'")
#+end_src
*** Yaml
#+begin_src emacs-lisp

(use-package yaml-ts-mode
  :mode "\\.ya?ml\\'"
  :mode "\\.ya?ml\\.j2\\'")

#+end_src
*** Web
#+begin_src emacs-lisp
(defvar web-mode-electric-pairs '((?' . ?')) "Electric pairs for org-mode.")

(defun web-mode-add-electric-pairs ()
  (setq-local electric-pair-pairs (append electric-pair-pairs web-mode-electric-pairs))
  (setq-local electric-pair-text-pairs electric-pair-pairs))
;; Major mode for editing web templates
(use-package web-mode
  :hook
  (web-mode . lsp-deferred)
  (web-mode . web-mode-add-electric-pairs)
  (web-mode . dtrt-indent-mode)
  (web-mode . (lambda ()
                (setq yas-after-exit-snippet-hook nil)))
  :mode "\\.[px]?html?\\'"
  :mode "\\.\\(?:tpl\\|blade\\)\\(?:\\.php\\)?\\'"
  :mode "\\.erb\\'"
  :mode "\\.[lh]?eex\\'"
  :mode "\\.jsp\\'"
  :mode "\\.as[cp]x\\'"
  :mode "\\.ejs\\'"
  :mode "\\.hbs\\'"
  :mode "\\.mustache\\'"
  :mode "\\.svelte\\'"
  :mode "\\.twig\\'"
  :mode "\\.jinja2?\\'"
  :mode "\\.eco\\'"
  :mode "wp-content/themes/.+/.+\\.php\\'"
  :mode "templates/.+\\.php\\'"
  :mode "\\.vue\\'"
  :mode "\\.tmpl\\'"
  :mode "\\.gotmpl\\'"
  :mode "\\.gohtml\\'"
  :mode "\\.astro\\'"
  :mode "\\.liquid\\'"
  :config
  (setq web-mode-enable-auto-indent nil)
  (setq web-mode-markup-indent-offset 2)
  (setq web-mode-css-indent-offset 2)
  (setq web-mode-code-indent-offset 2)
  (setq web-mode-script-padding 0)
  (setq web-mode-style-padding 0)
  (setq web-mode-engines-alist
        '(("go" . "\\.tmpl\\'")
          ("liquid" . "\\.liquid\\'"))))

(use-package emmet-mode
  :hook (web-mode . emmet-mode))

;; CSS mode
(use-package css-ts-mode
  :ensure nil
  :hook (css-ts-mode . lsp-deferred)
  :init (setq css-indent-offset 2))
#+end_src
*** Vue
#+begin_src emacs-lisp
;; https://github.com/emacs-lsp/lsp-mode/issues/4313#issuecomment-2051461893
(with-eval-after-load 'lsp-volar
  (lsp-dependency 'typescript
                  '(:npm :package "typescript"
                         :path "tsserver")))
#+end_src
*** Elixir
#+begin_src emacs-lisp
(use-package elixir-mode
  :mode "\\.exs\\'"
  :hook (elixir-mode . lsp-deferred))
#+end_src
*** SQL
#+begin_src emacs-lisp
;; Needs sqls installed and sqlint would be nice also
;; sqls: go get github.com/lighttiger2505/sqls
;; sqlint: gem install sqlint
(use-package sql
  :hook
  ((sql-mode . lsp)
   (sql-interactive-mode . (lambda () (toggle-truncate-lines t))))
  :config
  (setq lsp-sqls-timeout 10)
  (setq lsp-sqls-workspace-config-path "root"))
#+end_src
*** Markdown
#+begin_src emacs-lisp
(use-package markdown-mode
  :hook ((markdown-mode elfeed-show-mode) . olivetti-mode))
#+end_src
*** Mermaid
Install `mmdc`
`npm install -g @mermaid-js/mermaid-cli`
https://github.com/mermaid-js/mermaid-cli
#+begin_src emacs-lisp
(use-package mermaid-mode
  :mode "\\.mermaid\\'")
#+end_src
*** PHP
#+begin_src emacs-lisp
(use-package php-mode
  :hook (php-mode . lsp-deferred))
#+end_src
*** DotEnv
#+begin_src emacs-lisp
(use-package dotenv-mode
  :mode "\\.env\\..*\\'")
#+end_src
*** Docker
#+begin_src emacs-lisp
(use-package dockerfile-mode)
#+end_src
*** Scheme
#+begin_src emacs-lisp
(use-package geiser-guile
  :defer t)
#+end_src
** Flycheck
#+begin_src emacs-lisp

(use-package flycheck
  :diminish
  :commands flycheck-redefine-standard-error-levels
  :hook (after-init . global-flycheck-mode)
  :config
  (flycheck-add-mode 'javascript-eslint 'web-mode)
  (setq flycheck-javascript-eslint-executable "eslint_d"))

#+end_src

** Code Formatting
#+begin_src emacs-lisp
(use-package apheleia
  :vc (:url "https://github.com/radian-software/apheleia")
  :hook (after-init . apheleia-global-mode)
  :config
  (cl-pushnew '(eslint . ("eslint_d" "--fix-to-stdout" "--stdin" "--stdin-filename" file))
              apheleia-formatters
              :test #'equal)
  (cl-pushnew '(prettier-liquid . ("apheleia-npx" "prettier" "--stdin-filepath" filepath "--parser=html"))
              apheleia-formatters
              :test #'equal))

(defun daut/create-js-dirlocals ()
  "Create .dir-locals.el file in project root with JavaScript/TypeScript formatting settings."
  (interactive)
  (let* ((root (project-root (project-current t)))
         (dir-locals-file (expand-file-name ".dir-locals.el" root))
         (content '((nil . ((projectile-project-run-cmd . "npm run dev")
                            (projectile-project-install-cmd . "npm i")))
                    (js-mode . ((apheleia-formatter . eslint)))
                   (js-ts-mode . ((apheleia-formatter . eslint)))
                   (typescript-mode . ((apheleia-formatter . eslint)))
                   (typescript-ts-mode . ((apheleia-formatter . eslint)))
                   (json-ts-mode . ((apheleia-formatter . prettier-json)))
                   (js-json-mode . ((apheleia-formatter . prettier-json)))
                   (json-mode . ((apheleia-formatter . prettier-json)))
                   (web-mode . ((apheleia-formatter . eslint))))))
    (with-temp-file dir-locals-file
      (insert (pp-to-string content)))
    (message "Created .dir-locals.el at %s" dir-locals-file)))
#+end_src
** Avy
#+begin_src emacs-lisp
(use-package avy
  :bind (("s-." . avy-goto-char-timer)
         ("s-," . avy-goto-char)
         ("C-c ." . avy-goto-char-timer)
         ("C-c ," . avy-goto-char)
         ("M-g f" . avy-goto-line))
  :config
  (setq avy-background t)
  (setq avy-timeout-seconds 0.4))
#+end_src
** Ripgrep
#+begin_src emacs-lisp
(use-package rg)
#+end_src
** Tree-Sitter
#+begin_src emacs-lisp
(use-package treesit
  :ensure nil
  :config
  (setq treesit-language-source-alist
        '((astro "https://github.com/virchau13/tree-sitter-astro")
          (bash "https://github.com/tree-sitter/tree-sitter-bash")
          (css "https://github.com/tree-sitter/tree-sitter-css")
          (elisp "https://github.com/Wilfred/tree-sitter-elisp")
          (go "https://github.com/tree-sitter/tree-sitter-go")
          (gomod "https://github.com/camdencheek/tree-sitter-go-mod")
          (java "https://github.com/tree-sitter/tree-sitter-java")
          (javascript "https://github.com/tree-sitter/tree-sitter-javascript" "master" "src")
          (json "https://github.com/tree-sitter/tree-sitter-json")
          (typescript "https://github.com/tree-sitter/tree-sitter-typescript" "master" "typescript/src")
          (tsx "https://github.com/tree-sitter/tree-sitter-typescript" "master" "tsx/src")
          (vue "https://github.com/ikatyang/tree-sitter-vue")
          (yaml "https://github.com/ikatyang/tree-sitter-yaml")))
  (setq treesit-font-lock-level 4))

(use-package treesit-fold
  :vc (:url "https://github.com/emacs-tree-sitter/treesit-fold"
            :rev :newest)
  :hook ((typescript-ts-mode . treesit-fold-mode)
         (js-ts-mode . treesit-fold-mode)
         (go-ts-mode . treesit-fold-mode)
         (json-ts-mode . treesit-fold-mode)
         (java-ts-mode . treesit-fold-mode)
         (bash-ts-mode . treesit-fold-mode)
         (yaml-ts-mode . treesit-fold-mode))
  :bind
  (:map treesit-fold-mode-map
        ("C-s-[" . treesit-fold-close)
        ("C-s-]" . treesit-fold-open)
        ("C-c f i" . daut/treesit-fold-toggle-imports))
  :config
  ;; Centralized configuration for import queries
  (defvar daut/treesit-import-queries
    '((typescript . "(import_statement) @import")
      (tsx        . "(import_statement) @import")
      (javascript . "(import_statement) @import")
      (java       . "(import_declaration) @import")
      (go         . "(import_spec_list) @import"))
    "Alist mapping tree-sitter languages to their import statement queries.")

  (defun daut/treesit-get-import-query ()
    "Get the import query for the current buffer's tree-sitter language."
    (alist-get (treesit-language-at (point)) daut/treesit-import-queries))

  ;; Custom fold range function for imports - returns range covering ALL imports
  (defun daut/treesit-fold-range-imports (node offset)
    "Return fold range for all consecutive imports, starting from NODE."
    (let* ((import-query (daut/treesit-get-import-query))
           (nodes (when import-query
                    (treesit-query-capture (treesit-buffer-root-node) import-query)))
           (first-node (cdar nodes))
           (last-node (cdar (last nodes))))
      (when (and first-node last-node)
        (let ((beg (save-excursion
                     (goto-char (treesit-node-start first-node))
                     (end-of-line)
                     (point)))
              (end (treesit-node-end last-node)))
          (when (< beg end)
            (treesit-fold--cons-add (cons beg end) offset))))))

  ;; Add import folding to treesit-fold-range-alist (not Go - it already works)
  (push '(import_statement . daut/treesit-fold-range-imports)
        (alist-get 'typescript-ts-mode treesit-fold-range-alist))
  (push '(import_statement . daut/treesit-fold-range-imports)
        (alist-get 'js-ts-mode treesit-fold-range-alist))
  (push '(import_declaration . daut/treesit-fold-range-imports)
        (alist-get 'java-ts-mode treesit-fold-range-alist))

  ;; Toggle function for manual use (works from anywhere in file)
  (defun daut/treesit-fold-toggle-imports ()
    "Toggle folding of all import statements at the top of the file."
    (interactive)
    (save-excursion
      (goto-char (point-min))
      (when-let ((import-query (daut/treesit-get-import-query)))
        (when-let ((nodes (treesit-query-capture (treesit-buffer-root-node) import-query)))
          (goto-char (treesit-node-start (cdar nodes)))
          (treesit-fold-toggle)))))

  ;; Auto-fold imports on file open - runs directly, no timer needed
  (defun daut/treesit-auto-fold-imports ()
    "Auto-fold imports when treesit-fold-mode is enabled."
    (save-excursion
      (goto-char (point-min))
      (when-let ((import-query (daut/treesit-get-import-query)))
        (when-let ((nodes (treesit-query-capture (treesit-buffer-root-node) import-query)))
          (goto-char (treesit-node-start (cdar nodes)))
          (ignore-errors (treesit-fold-close))))))

  (add-hook 'treesit-fold-mode-hook #'daut/treesit-auto-fold-imports))
#+end_src
** Docs
#+begin_src emacs-lisp
(use-package devdocs
  :defer t)
#+end_src
* AI Assistants
** copilot.el
#+begin_src emacs-lisp
(use-package copilot
  :hook ((prog-mode restclient-mode eshell-mode yaml-mode org-mode markdown-mode) . copilot-mode)
  :bind
  ("C-<tab>" . copilot-complete)
  ;; ("s-c" . copilot-toggle-auto-complete)
  :config
  (define-key copilot-completion-map (kbd "C-TAB") 'copilot-accept-completion)
  (define-key copilot-completion-map (kbd "C-<tab>") 'copilot-accept-completion)
  (setopt copilot-indent-offset-warning-disable t)
  (setopt copilot-max-char 1000000)
  (setopt copilot-idle-delay 0)
  (defun copilot-toggle-auto-complete ()
    "Toggle automatic completion overlay behavior.
When enabled, Copilot will automatically show completion suggestions
after a short idle delay. When disabled, completions only appear
through manual triggers."
    (interactive)
    (setq copilot-idle-delay (if (eq copilot-idle-delay nil) 0 nil))
    (message "Copilot idle delay set to: %s" copilot-idle-delay)))
#+end_src
** opencode.el
#+begin_src emacs-lisp
(use-package opencode
  :vc (:url "https://codeberg.org/sczi/opencode.el.git" :rev :newest)
  :commands (opencode opencode-new-session))
#+end_src
** beads
#+begin_src emacs-lisp
(use-package beads
  :vc (:url "https://codeberg.org/ctietze/beads.el"
       :lisp-dir "lisp"
       :rev :newest))
#+end_src
* VCS
** Magit
#+begin_src emacs-lisp

(use-package magit
  :commands magit-status
  :config
  (setq magit-diff-refine-hunk nil)
  :bind (("C-c m f" . magit-pull)
         ("C-c m i" . magit-init)
         ("C-c m c" . magit-clone)
         ("C-c m l" . magit-log-current)))

(use-package magit-todos
  :after magit
  :config (magit-todos-mode 1))

;; add options to magit like create PR, track issues etc.
(use-package forge
  :after magit)

#+end_src
** Git Gutter
#+begin_src emacs-lisp
(use-package git-gutter
  :config (global-git-gutter-mode t))
;; try hl-mode (dired-mode . diff-hl-dired-mode)
#+end_src
** Blamer
#+begin_src emacs-lisp
(use-package blamer
  :ensure t
  :bind (("s-i" . blamer-show-commit-info)
         ("C-c i" . blamer-show-posframe-commit-info))
  :defer 20
  :custom
  (blamer-idle-time 0.3)
  (blamer-min-offset 70))
#+end_src
* Terminals
** term-mode
#+begin_src emacs-lisp

(use-package term
  :commands term
  :config
  (setq term-prompt-regexp "^[^#$%>\\n]*[#$%>] *"))

(use-package eterm-256color
  :hook (term-mode . eterm-256color-mode))

#+end_src
** vterm
#+begin_src emacs-lisp

(use-package vterm
  :commands vterm
  :config
  (setq vterm-shell "fish")
  (setq vterm-max-scrollback 10000))

(defvar vterm-toggle-window-state nil)

(defun toggle-vterm-window ()
  (interactive)
  (if vterm-toggle-window-state
      (progn
        (delete-window (get-buffer-window "*vterm*"))
        (setq vterm-toggle-window-state nil))
    (let* ((height (floor (* 0.25 (frame-height))))
           (new-window (split-root-window-below (- (frame-height) height)))
           (project-dir (projectile-project-root)))
      (select-window new-window)
      (vterm)
      (when project-dir
        (vterm-send-string (concat "cd " project-dir))
        (vterm-send-return))
      (setq vterm-toggle-window-state t))))

(global-set-key (kbd "C-`") 'toggle-vterm-window)

#+end_src
** eshell
#+begin_src emacs-lisp

(use-package eshell-git-prompt
  :after eshell)

(defun daut/configure-eshell ()
  ;; save command history when commands are entered
  (add-hook 'eshell-pre-command-hook 'eshell-save-some-history)

  ;; truncate buffer for performance
  (add-to-list 'eshell-output-filter-functions 'eshell-truncate-buffer)

  ;; better color support
  (add-hook 'eshell-mode-hook (lambda() (setenv "TERM" "xterm-256color")))

  (setq eshell-history-size         10000
        eshell-buffer-maximum-lines 10000
        eshell-history-ignoredups t
        eshell-scroll-to-bottom-on-input t))

(use-package eshell
  :hook (eshell-first-time-mode . daut/configure-eshell)
  :config
  (with-eval-after-load 'esh-opt
    (setq eshell-destroy-buffer-when-process-dies t)
    (setq eshell-visual-commands '("zsh" "vim")))
  (eshell-git-prompt-use-theme 'powerline))

(use-package esh-autosuggest
  :hook (eshell-mode . esh-autosuggest-mode))
#+end_src
* File Management
** Basic
#+begin_src emacs-lisp

;; Auto refresh buffers
(global-auto-revert-mode t)

;; Also auto refresh dired, but be quiet about it
(setq global-auto-revert-non-file-buffers t)
(setq auto-revert-verbose nil)

;; Make buffer list usable after previous changes
;; https://github.com/syl20bnr/spacemacs/issues/7661
;; https://github.com/syl20bnr/spacemacs/issues/2667#issuecomment-136155556
(add-hook 'Buffer-menu-mode-hook 
          (lambda ()
            (setq-local revert-buffer-function
                        (lambda (&rest args)))))

;; Backup files directory path

(setq backup-directory-alist `((".*" . ,temporary-file-directory)))
(setq auto-save-file-name-transforms `((".*" ,temporary-file-directory t)))

(setopt backup-by-copying-when-linked t)
;; trying to prevent tsserver from adding backup files saved in temp dir to tsconfig.json
;; https://github.com/emacs-lsp/lsp-mode/issues/3516
(setopt backup-by-copying t)
(setq delete-old-versions t
      kept-new-versions 6
      kept-old-versions 2
      version-control t)

#+end_src

** Dired
Note: coreutils had to be installed on MacOS systems for group-directories-first to work so run `brew install coreutils`.
#+begin_src emacs-lisp

(use-package dired
  :ensure nil
  :commands (dired dired-jump)
  :config
  (when (string= system-type "darwin")
    (setq insert-directory-program (executable-find "gls")))
  (setq dired-kill-when-opening-new-dired-buffer t)
  :custom
  (dired-listing-switches "-agho --group-directories-first")
  (setq delete-by-moving-to-trash t))

;; Colorful dired
(use-package diredfl
  :hook (dired-mode . diredfl-mode))

;; Shows icons
(use-package nerd-icons-dired
  :diminish
  ;; :when (icons-displayable-p)
  ;; :custom-face
  ;; (nerd-icons-dired-dir-face ((t (:inherit nerd-icons-dsilver :foreground unspecified))))
  :hook (dired-mode . nerd-icons-dired-mode))

#+end_src
** Dired sidebar
#+begin_src emacs-lisp
(use-package dired-sidebar
  :bind (("s-b" . dired-sidebar-toggle-sidebar))
  :commands (dired-sidebar-toggle-sidebar)
  :custom
  (dired-sidebar-display-alist '((side . right)))
  :config
  (setq dired-sidebar-theme 'nerd))
#+end_src
** 0x0
#+begin_src emacs-lisp
(defun 0x0-upload-file (file-path)
  "Upload a file at FILE-PATH to 0x0.st and copy the URL to the kill ring."
  (interactive "fSelect a file to upload: ")
  (message "Sending %s to 0x0.st..." file-path)
  (let ((url (string-trim-right
              (shell-command-to-string
               (format "curl -s -F'file=@%s' https://0x0.st" (expand-file-name file-path))))))
    (message "0x0.st URL: %s" url)
    (kill-new url)))
#+end_src
* Window Management
** Basic
#+begin_src emacs-lisp
(setq switch-to-buffer-obey-display-actions t)

(defun daut/toggle-window-dedication ()
  "Toggles window dedication in the selected window."
  (interactive)
  (set-window-dedicated-p (selected-window)
                          (not (window-dedicated-p (selected-window)))))

(defun daut/toggle-window-size-fixed ()
  (interactive)
  (setq-default window-size-fixed (not window-size-fixed))
  (message "Window size fixed: %s" window-size-fixed))

(defvar-local daut/original-lock nil
  "Holds the original value of window-size-fixed.")

(defun daut/interactive-window-resize ()
  (interactive)
  (setq daut/original-lock window-size-fixed)
  (setq-default window-size-fixed nil)
  (hydra-window-scale/body))
#+end_src
** Winner Mode
#+begin_src emacs-lisp
(use-package winner-mode
  :ensure nil
  :commands (winner-undo winner-redo)
  :hook (after-init . winner-mode)
  :bind (("C-c w u" . winner-undo)
         ("C-c w r" . winner-redo))
  :init (setq winner-boring-buffers '("*Completions*"
                                      "*Compile-Log*"
                                      "*inferior-lisp*"
                                      "*Fuzzy Completions*"
                                      "*Apropos*"
                                      "*Help*"
                                      "*cvs*"
                                      "*Buffer List*"
                                      "*Ibuffer*"
                                      "*esh command on file*")))
#+end_src
** Transpose frame
#+begin_src emacs-lisp
(use-package transpose-frame)
#+end_src
* Workspace Management
** Other Window
#+begin_src emacs-lisp
(defun daut/other-window-backward ()
  (interactive)
  (other-window -1)
  (pulsar-recenter-center))

(defun daut/other-window-forward ()
  (interactive)
  (other-window 1)
  (pulsar-recenter-center))

(defun daut/ace-window-pulsar (&rest _)
  "Advice function to trigger pulsar after ace-window."
  (pulsar-recenter-center))

(use-package ace-window
  :init
  (advice-add 'ace-window :after #'daut/ace-window-pulsar)
  :bind
  (("C-x o" . ace-window)
   ("s-[" . daut/other-window-backward)
   ("s-]" . daut/other-window-forward))
  :config
  (setq aw-dispatch-always t))
#+end_src
** Perspective
#+begin_src emacs-lisp
(use-package perspective
  :hook (kill-emacs . persp-save-default)
  :init (persp-mode)
  :bind (("C-x k" . persp-kill-buffer*)
         ("s-}" . persp-next)
         ("s-{" . persp-prev))
  :custom
  (persp-mode-prefix-key (kbd "C-c C-p"))
  :config
  (defun persp-save-default ()
    (let ((current-prefix-arg '(4)))
      (persp-state-save (concat user-emacs-directory "persp.el"))))
  (defun persp-create-aux ()
    "Create a new auxilliary perspective."
    (interactive)
    (let ((current-persp (persp-current-name)))
      (persp-switch "aux")
      (persp-switch current-persp)))
  (setq persp-state-default-file (concat user-emacs-directory "persp-")))
#+end_src
* RSS
#+begin_src emacs-lisp
(use-package elfeed
  :defer t
  :config
  (setq elfeed-feeds
        '(("https://world.hey.com/dhh/feed.atom" dhh)
          ("https://forum.systemcrafters.net/posts.rss" sc)
          ("https://karthinks.com/index.xml" karthinks)
          ("https://protesilaos.com/codelog.xml" prot)
          ("https://www.masteringemacs.org/feed" masteringemacs))))
#+end_src
* Keybinding Configuration
** Custom functions
#+begin_src emacs-lisp

;; scroll up/down one line
(global-set-key (kbd "C-s-n") (kbd "C-u 1 C-v"))
(global-set-key (kbd "C-s-p") (kbd "C-u 1 M-v"))

;; Make ESC quit prompts
(global-set-key (kbd "<escape>") 'keyboard-escape-quit)

(defun daut/backward-delete-word (arg)
  "Delete characters backward until encountering the beginning of a word.
With argument ARG, do this that many times."
  (interactive)
  (delete-region (point) (progn (backward-word arg) (point))))

(defun daut/delete-word (arg)
  "Delete characters forwards until encountering the beginning of a word.
With argument ARG, do this that many times."
  (interactive "p")
  (delete-region (point) (progn (forward-word arg) (point))))

(defun daut/backward-delete-char-or-word ()
  "backward delete behave more like VS Code"
  (interactive)
  (cond
   ((looking-back (rx (char word)) 1)
    (daut/backward-delete-word 1))
   ((looking-back (rx (char blank)) 1)
    (delete-horizontal-space t))
   (t
    (backward-delete-char 1))))

(defun insert-iso8601-date ()
  "Insert current date in ISO 8601 format with timezone."
  (interactive)
  (insert 
   (format-time-string "%Y-%m-%dT%H:%M:%S%:z")))
#+end_src
** Hydra

#+begin_src emacs-lisp

(use-package hydra
  :defer t)

(defhydra hydra-text-scale (:timeout 4)
  "scale text"
  ("j" text-scale-increase "in")
  ("k" text-scale-decrease "out")
  ("f" nil "cancel" :exit t))

(defhydra hydra-window-scale (:timeout 4
                                       :post (setq-default window-size-fixed daut/original-lock))
  "scale window horizontally"
  ("j" (enlarge-window-horizontally 5) "enlarge horizontally")
  ("k" (shrink-window-horizontally 5) "shrink horizontally")
  ("p" (enlarge-window 5) "enlarge vertically")
  ("n" (shrink-window 5) "shrink vertically")
  ("f" nil "cancel" :exit t))

#+end_src
** General package
#+begin_src emacs-lisp
(use-package general
  :config
  (general-create-definer daut/leader-keys
    :prefix "C-C")
  (daut/leader-keys
    "t"  '(:ignore t :which-key "toggles")
    "o"  '(:ignore t :which-key "org-files")
    "s"  '(:ignore t :which-key "shell/sql")
    "f"  '(:ignore t :which-key "files or folders")
    "h"  '(:ignore t :which-key "hydra")
    "w"  '(:ignore t :which-key "window")
    "fd" '(:ignore t :which-key "directories")
    "fdp" '((lambda () (interactive) (dired "~/projects")) :which-key "projects")
    "tt" '(consult-theme :which-key "choose theme")
    "ts" '(hydra-text-scale/body :which-key "scale text")
    "se" '(eshell :which-key "eshell")
    "sE" '((lambda () (interactive) (eshell t)) :which-key "New eshell")
    "sc" '(sql-connect :which-key "sql-connect")

    "oc" '(org-capture t :which-key "org-capture")
    "oa" '(org-agenda t :which-key "org-agenda")
    "oi" '((lambda () (interactive) (find-file (expand-file-name "~/projects/org/gtd/inbox.org"))) :which-key "inbox.org")
    "og" '((lambda () (interactive) (find-file (expand-file-name "~/projects/org/gtd/gtd.org"))) :which-key "gtd.org")
    "oe" '((lambda () (interactive) (find-file (expand-file-name "~/projects/dotfiles/Emacs.org"))) :which-key "Emacs.org")
    "ot" '((lambda () (interactive) (find-file (expand-file-name "~/projects/org/Tasks.org"))) :which-key "Tasks.org")
    "od" '((lambda () (interactive) (find-file (expand-file-name "~/projects/org/Daily.org"))) :which-key "Daily.org")
    "wl" '((lambda () (interactive) (daut/toggle-window-size-fixed)) :which-key "Toggle window size fixed")
    "ws" '((lambda () (interactive) (daut/interactive-window-resize)) :which-key "horizontally scale window")
    "wt" '((lambda () (interactive) (transpose-frame)) :which-key "change window split direction"))

  (general-define-key
   :keymaps 'global-map
   "C-s-n" (kbd "C-u 1 C-v")
   "C-s-p" (kbd "C-u 1 M-v")

   "<escape>" 'keyboard-escape-quit

   [remap backward-kill-word] 'daut/backward-delete-char-or-word
   [remap kill-word] 'daut/delete-word

   "C-s-," (lambda () (interactive) (forward-line -30) (pulsar-pulse-line))
   "C-s-." (lambda () (interactive) (forward-line 30) (pulsar-pulse-line))

   "s-<" #'beginning-of-buffer
   "s->" #'end-of-buffer
   "C-s-f" 'toggle-frame-fullscreen))
#+end_src
** Crux package
#+begin_src emacs-lisp

(use-package crux
  :bind
  ([remap move-beginning-of-line] . crux-move-beginning-of-line)
  ("C-c d" . crux-duplicate-current-line-or-region)
  ("C-c k" . crux-kill-other-buffers)
  ("C-c b s" . crux-create-scratch-buffer))

#+end_src

